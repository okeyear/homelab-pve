name: "[ 01 ] Setup VM template"

on:
  workflow_dispatch:
    inputs:
      runner:
        description: 'Github Action Runner/Agent'
        required: true
        default: self-hosted
        type: choice
        options:
          - self-hosted
          - ubuntu-latest

      OS:
        description: 'OS Version'
        required: true
        default: 'almalinux9'
        type: choice      
        options:
          - ubuntu24.04
          - ubuntu22.04
          - debian13
          - debian12
          - debian11
          - almalinux10
          - almalinux9
          - almalinux8
          - centos7
          - centos9stream
          - alinux3
          - openEuler2403

      STORAGE:
        description: 'Storage'
        required: true
        default: 'local-zfs'
        type: choice      
        options:
          - local-zfs
          - local-lvm
          - local

env:
  TAILSCALE_HOST: ${{ vars.TAILSCALE_HOST }}
  TAILSCALE_NET: ${{ vars.TAILSCALE_NET }}
  CIDR: ${{ vars.CIDR }}  # vmbr0 vmbr1 çš„ç½‘æ®µ
  DNS: 223.5.5.5
  STORAGE:  ${{ github.event.inputs.STORAGE }} # 'local-lvm' 'local' 'local-zfs'

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  setup-template:
    name: ğŸš€ Setup OS template ${{ github.event.inputs.OS }}
    # The type of runner that the job will run on
    # runs-on: [self-hosted]
    # runs-on: ubuntu-latest
    runs-on: ${{ github.event.inputs.runner }}
    permissions:
      id-token: write   # è®© GitHub é¢å‘ OIDC
    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      # - uses: actions/checkout@v4

      # 1ï¸âƒ£  æŠŠ Runner æ¥å…¥ tailnet
      - name: Tailscale Connect
        uses: tailscale/github-action@v3
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret:    ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:ci     # ä¸ ACL ä¸­çš„ tag ä¿æŒä¸€è‡´
          version: latest # https://pkgs.tailscale.com/stable/#static
          use-cache: 'true'

      # 2ï¸âƒ£  æ­£å¸¸é€šè¿‡ 100.x æˆ–ä¸»æœºåè®¿é—®è¿œç¨‹æœº
      - name: Remote command via SSH
        run: |
          # pveHost=$(tailscale status --json | jq -r '.Self.HostName' )
          # sudo tailscale up --advertise-tags=tag:gh --accept-routes --hostname=${pveHost}
          # tailscale status
          test -d ~/.ssh || mkdir -p ~/.ssh
          ssh-keyscan -H ${{ env.TAILSCALE_HOST }}.${{ env.TAILSCALE_NET }} >> ~/.ssh/known_hosts
          # ssh root@${{ env.TAILSCALE_HOST }}.${{ env.TAILSCALE_NET }} "qm list"
          # sudo apt install -yq cloud-image-utils

      - name: Setup Debian script
        if: contains(github.event.inputs.OS, 'debian')
        run: |
          echo setup Debian script ...
          if [ "${{ github.event.inputs.OS }}" = "debian13" ]; then
            DEBIAN_VERSION=13 ; DEBIAN_NAME='trixie'
            SETUP_DEBIAN_SCRIPT=setup_debian_ge_13.sh
          elif [ "${{ github.event.inputs.OS }}" = "debian12" ]; then
            DEBIAN_VERSION=12 ; DEBIAN_NAME='bookworm'
            SETUP_DEBIAN_SCRIPT=setup_debian_le_12.sh
          elif [ "${{ github.event.inputs.OS }}" = "debian11" ]; then
            DEBIAN_VERSION=11 ; DEBIAN_NAME='Bullseye'   
            SETUP_DEBIAN_SCRIPT=setup_debian_le_12.sh        
          fi
          VM_ID=21${DEBIAN_VERSION}
          echo "DEBIAN_VERSION=$DEBIAN_VERSION"      >> "$GITHUB_ENV"
          echo "DEBIAN_NAME=$DEBIAN_NAME"      >> "$GITHUB_ENV"
          echo "VM_ID=$VM_ID"      >> "$GITHUB_ENV"
          echo "SETUP_DEBIAN_SCRIPT=$SETUP_DEBIAN_SCRIPT"      >> "$GITHUB_ENV"

          cat > setup_debian_le_12.sh <<'EOF'
          sudo sed -i 's|^deb http://ftp.debian.org|deb https://mirrors.ustc.edu.cn|g' /etc/apt/sources.list
          sudo sed -i 's|^deb http://security.debian.org|deb https://mirrors.ustc.edu.cn/debian-security|g' /etc/apt/sources.list
          EOF

          cat > setup_debian_ge_13.sh <<'EOF'
          echo https://mirrors.ustc.edu.cn/debian-security > /etc/apt/mirrors/debian-security.list
          echo http://mirrors.tencent.com/debian > /etc/apt/mirrors/debian.list
          EOF
      - name: Setup Debian ${{ github.event.inputs.OS }} Template
        if: contains(github.event.inputs.OS, 'debian')
        run: |
          echo setup ${{ github.event.inputs.OS }} ...
          cat > setup_debian_tpl.sh <<EOF
          wget -c https://cloud.debian.org/images/cloud/${DEBIAN_NAME}/latest/debian-${DEBIAN_VERSION}-genericcloud-amd64.qcow2

          # disk
          qemu-img resize debian-${DEBIAN_VERSION}-genericcloud-amd64.qcow2 20G
          # qm disk resize $VM_ID scsi0 40G # è®¾ç½®ç¡¬ç›˜å¤§å°

          qm create $VM_ID --core 2 --memory 4096 --name debian${DEBIAN_VERSION}tpl --net0 virtio,bridge=vmbr1
          qm importdisk $VM_ID debian-${DEBIAN_VERSION}-genericcloud-amd64.qcow2 ${STORAGE}
          qm set $VM_ID --scsihw virtio-scsi-pci --scsi0 ${STORAGE}:vm-${VM_ID}-disk-0 # ${STORAGE}:${VM_ID}/vm-${VM_ID}-disk-0.raw # 
          qm set $VM_ID --tags "template;${{ github.event.inputs.OS }}"
          qm set $VM_ID --ide2 ${STORAGE}:cloudinit
          qm set $VM_ID --boot cdn --bootdisk scsi0
          qm set $VM_ID --serial0 socket --vga serial0
          # ä¿®æ”¹å›½å†…æºç­‰,å‚è€ƒä¿®æ”¹è„šæœ¬
          # sshå…å¯†é’¥, ç”¨vagrantçš„å³å¯,ç”Ÿäº§ç¯å¢ƒä¸åˆé€‚
          # sudo curl -o /home/vagrant/.ssh/authorized_keys https://raw.githubusercontent.com/hashicorp/vagrant/master/keys/vagrant.pub
          # å¯¼å…¥sshå…¬é’¥åˆ°è™šæ‹Ÿç³»ç»Ÿ
          qm set $VM_ID --sshkey ~/.ssh/id_rsa.pub
          qm set $VM_ID --ipconfig0 ip=${CIDR}.250/24,gw=${CIDR}.1  # è®¾ç½®ip
          qm set $VM_ID --cipassword vagrant --ciuser vagrant # è®¾ç½®ç”¨æˆ·å’Œå¯†ç ã€‚æ³¨æ„å¯†ç åœ¨è®¾ç½®ä¹‹åï¼Œä¼šè‡ªåŠ¨éšè—ã€‚
          qm set $VM_ID --searchdomain example.com --nameserver ${DNS}
          qm set $VM_ID --agent 1 # éœ€è¦é…åˆ qemu-guest-agent

          qm start $VM_ID    
          sleep 45

          # è®¿é—®
          ssh-keygen -f "/root/.ssh/known_hosts" -R "${CIDR}.250"
          # å°†è„šæœ¬å†…å®¹ä½œä¸ºå‘½ä»¤æ‰§è¡Œ
          # qm guest exec $VM_ID -- bash -c "\$(cat setup_ubuntu.sh)"
          # alias ssh='ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null'
          # cat setup_ubuntu.sh | ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null vagrant@${CIDR}.250 'sudo bash -s'
          rsync -e  'ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null' \
              -avz --partial --progress --inplace ${SETUP_DEBIAN_SCRIPT} vagrant@${CIDR}.250:/home/vagrant/
          ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null vagrant@${CIDR}.250 "bash ${SETUP_DEBIAN_SCRIPT}"
          EOF
          cat ${SETUP_DEBIAN_SCRIPT}

          # copy scripts to PVE
          for pkg in setup_debian*.sh
          do
            rsync -e  'ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null' \
              -avz --partial --progress --inplace $pkg root@${{ env.TAILSCALE_HOST }}.${{ env.TAILSCALE_NET }}:/root/
          done

          # exec scripts on PVE
          ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
          root@${{ env.TAILSCALE_HOST }}.${{ env.TAILSCALE_NET }} "bash setup_debian_tpl.sh; sleep 5; qm stop $VM_ID; sleep 5;qm set $VM_ID --ciupgrade 1; qm template $VM_ID"                
          
      - name: Setup Ubuntu script
        # if: github.event.inputs.OS == 'ubuntu2404'
        if: contains(github.event.inputs.OS, 'ubuntu')
        run: |
          echo setup ubuntu script ...
          version=$(echo ${{ github.event.inputs.OS }} | sed 's@ubuntu@@')
          vmid=${version/./}
          echo "ubuntu_ver=$version"      >> "$GITHUB_ENV"
          echo "VM_ID=$vmid"      >> "$GITHUB_ENV"

          cat > setup_ubuntu.sh <<'EOF'
          export DEBIAN_FRONTEND=noninteractive
          source /etc/os-release
          # echo ${VERSION_CODENAME} ${UBUNTU_CODENAME}
          sudo sed -i '/^PasswordAuthentication/s/no/yes/' /etc/ssh/sshd_config /etc/ssh/sshd_config.d/*.conf
          echo "PermitRootLogin yes" | sudo tee /etc/ssh/sshd_config.d/01-permitrootlogin.conf
          sudo mv /etc/apt/sources.list{,.bak.init}
          sudo tee /etc/apt/sources.list <<ENDIF
          # é»˜è®¤æ³¨é‡Šäº†æºç é•œåƒä»¥æé«˜ apt update é€Ÿåº¦ï¼Œå¦‚æœ‰éœ€è¦å¯è‡ªè¡Œå–æ¶ˆæ³¨é‡Š
          deb https://mirrors.aliyun.com/ubuntu/ ${UBUNTU_CODENAME} main restricted universe multiverse
          deb https://mirrors.aliyun.com/ubuntu/ ${UBUNTU_CODENAME}-updates main restricted universe multiverse
          deb https://mirrors.aliyun.com/ubuntu/ ${UBUNTU_CODENAME}-backports main restricted universe multiverse
          deb https://mirrors.aliyun.com/ubuntu/ ${UBUNTU_CODENAME}-security main restricted universe multiverse
          ENDIF
          sleep 2
          # kvm agent
          sudo apt update -y
          sudo apt install -yq vim wget telnet qemu-guest-agent
          sleep 2
          # å‡çº§kernel å‚è€ƒå…¶ä»–éƒ¨åˆ†
          # ä¿®æ”¹ è®©æœ¬åœ°hostsç”Ÿæ•ˆ
          sudo sed -i '/update_etc_hosts/s/^#*/#/' /etc/cloud/cloud.cfg 
          echo 'apt_preserve_sources_list: true' | sudo tee -a /etc/cloud/cloud.cfg.d/99-disable-apt-overwrite.cfg

          # å¼€å¯sshdçš„å¯†ç éªŒè¯
          # sudo sed -i '/ssh_pwauth/s/false/true/' /etc/cloud/cloud.cfg
          sudo sed -i '/^disable_root/s/true/false/' /etc/cloud/cloud.cfg
          
          sudo apt upgrade -yq
          sudo apt-get clean && sudo rm -rf /var/lib/apt/lists/*
          history -c
          sudo init 0
          EOF

      - name: Setup Ubuntu ${{ github.event.inputs.OS }} Template
        # if: github.event.inputs.OS == 'ubuntu2204'
        if: contains(github.event.inputs.OS, 'ubuntu')
        run: |
          echo setup ${{ github.event.inputs.OS }} ...
          # ubuntu_ver='22.04' # 20.04
          # VM_ID=${ubuntu_ver/./}
          cat > setup_ubuntu_tpl.sh <<EOF
          # 1. download cloud image
          # wget http://cloud-images.ubuntu.com/releases/focal/release/ubuntu-20.04-server-cloudimg-amd64-disk-kvm.img
          wget -c https://cloud-images.ubuntu.com/releases/${ubuntu_ver}/release/ubuntu-${ubuntu_ver}-server-cloudimg-amd64.img
          
          VM_ID=$VM_ID
          qm shutdown ${VM_ID} --forceStop
          sleep 2
          qm destroy ${VM_ID} --purge

          # ç£ç›˜é»˜è®¤2.2G, è®¾ç½®ä¸º20G
          qemu-img info ubuntu-${ubuntu_ver}-server-cloudimg-amd64.img
          qemu-img resize ubuntu-${ubuntu_ver}-server-cloudimg-amd64.img 20G
          qemu-img info ubuntu-${ubuntu_ver}-server-cloudimg-amd64.img

          # 2. create vm
          # åˆ›å»º id ä¸º 1000 çš„è™šæ‹Ÿæœºï¼Œå†…å­˜å¤§å°ä¸º 2G ï¼Œ CPU æ ¸å¿ƒæ•°é‡ 2ï¼Œåç§°æ˜¯ ubuntu22.04-template å¹¶è®¾ç½®ç½‘å¡æ¡¥æ¥åˆ° vmbr0
          qm create $VM_ID --core 2 --memory 4096 --name ubuntu${ubuntu_ver/./}tpl --net0 virtio,bridge=vmbr1

          # 3. å¯¼å…¥ä¸‹è½½å¥½çš„äº‘é•œåƒåˆ° local-lvm å­˜å‚¨; å¦‚æœæ²¡æœ‰é¢å¤–å­˜å‚¨ï¼Œåˆ™é»˜è®¤æ˜¯local
          qm importdisk $VM_ID ubuntu-${ubuntu_ver}-server-cloudimg-amd64.img  ${STORAGE}

          # è½¬æ¢äº‘é•œåƒä¸ºè™šæ‹Ÿç£ç›˜
          # qm importdisk $VM_ID ubuntu-20.04-server-cloudimg-amd64.img raid0 --format=qcow2
          # 104 ä¸ºè™šæ‹Ÿæœºçš„ID
          # raid0 ä¸ºå­˜å‚¨çš„åç§°ï¼Œå¦‚æœæ²¡æœ‰é¢å¤–å­˜å‚¨ï¼Œåˆ™é»˜è®¤æ˜¯local
          # --format=qcow2 ä¸ºè½¬æ¢åçš„æ ¼å¼

          # 4. å°†æ–°å¯¼å…¥çš„ç£ç›˜ä»¥ scsi é©±åŠ¨å™¨çš„æ–¹å¼è£…è½½åˆ°æ–°å»ºçš„è™šæ‹Ÿæœºçš„ scsi æ§åˆ¶å™¨
          # é€‚ç”¨äºlocal-lvm
          qm set $VM_ID --scsihw virtio-scsi-pci --scsi0 ${STORAGE}:vm-${VM_ID}-disk-0
          # é€‚ç”¨äºlocal
          # qm set $VM_ID --scsihw virtio-scsi-pci --scsi0 ${STORAGE}:${VM_ID}/vm-${VM_ID}-disk-0.raw
          qm set $VM_ID --tags "template;${{ github.event.inputs.OS }}"

          # è®¾ç½®ç£ç›˜æš‚æ—¶æœªç”Ÿæ•ˆ qm set $VM_ID --scsi0 file=local-lvm:vm-${VM_ID}-disk-0,size=20480M
          qm disk resize $VM_ID scsi0 20G # è®¾ç½®ç¡¬ç›˜å¤§å°

          # 5. æ·»åŠ  cloud init é©±åŠ¨å™¨
          # The next step is to configure a CDROM drive which will be used to pass the Cloud-Init data to the VM.
          qm set $VM_ID --ide2  ${STORAGE}:cloudinit

          # 6. å°† cloud init é©±åŠ¨å™¨è®¾ç½®ä¸ºå¯å¯åŠ¨å¹¶é™åˆ¶ BIOS ä»…ä»ç£ç›˜å¯åŠ¨
          # To be able to boot directly from the Cloud-Init image, set the bootdisk parameter to scsi0, and restrict BIOS to boot from disk only. This will speed up booting, because VM BIOS skips the testing for a bootable CDROM. 
          # --boot cdn //å¯åŠ¨é¡ºåºã€‚cdrom  disk network 
          qm set $VM_ID --boot cdn --bootdisk scsi0

          # 7. æ·»åŠ ä¸²å£æ§åˆ¶å°
          # Also configure a serial console and use it as a display. Many Cloud-Init images rely on this, as it is an requirement for OpenStack images.
          qm set $VM_ID --serial0 socket --vga serial0

          # å¯¼å…¥sshå…¬é’¥åˆ°è™šæ‹Ÿç³»ç»Ÿ
          qm set $VM_ID --sshkey ~/.ssh/id_rsa.pub
          qm set $VM_ID --ipconfig0 ip=$CIDR.250/24,gw=$CIDR.1  # è®¾ç½®ip
          qm set $VM_ID --cipassword vagrant --ciuser vagrant --ciupgrade 0   # è®¾ç½®ç”¨æˆ·å’Œå¯†ç ã€‚æ³¨æ„å¯†ç åœ¨è®¾ç½®ä¹‹åï¼Œä¼šè‡ªåŠ¨éšè—ã€‚
          # qm set $VM_ID --ssh-pwauth 1
          qm set $VM_ID --searchdomain example.com --nameserver ${DNS}
          qm set $VM_ID --agent 1 # éœ€è¦é…åˆ qemu-guest-agent     
          
          qm start $VM_ID
          sleep 45

          # è®¿é—®
          ssh-keygen -f "/root/.ssh/known_hosts" -R "${CIDR}.250"
          # å°†è„šæœ¬å†…å®¹ä½œä¸ºå‘½ä»¤æ‰§è¡Œ
          # qm guest exec $VM_ID -- bash -c "\$(cat setup_ubuntu.sh)"
          # alias ssh='ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null'
          # cat setup_ubuntu.sh | ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null vagrant@${CIDR}.250 'sudo bash -s'
          rsync -e  'ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null' \
              -avz --partial --progress --inplace setup_ubuntu.sh vagrant@${CIDR}.250:/home/vagrant/
          ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null vagrant@${CIDR}.250 'bash setup_ubuntu.sh'
          EOF
          cat setup_ubuntu_tpl.sh

          # copy scripts to PVE
          for pkg in setup_ubuntu*.sh
          do
            rsync -e  'ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null' \
              -avz --partial --progress --inplace $pkg root@${{ env.TAILSCALE_HOST }}.${{ env.TAILSCALE_NET }}:/root/
          done

          # exec scripts on PVE
          ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
          root@${{ env.TAILSCALE_HOST }}.${{ env.TAILSCALE_NET }} "bash setup_ubuntu_tpl.sh; sleep 5; qm stop $VM_ID; sleep 5;qm set $VM_ID --ciupgrade 1; qm template $VM_ID"

      - name: Setup AlmaLinux script
        if: contains(github.event.inputs.OS, 'almalinux')
        run: |
          echo setup AlmaLinux script ...
          version=$(echo ${{ github.event.inputs.OS }} | sed 's@almalinux@@')
          vmid=200${version}
          echo "almalinux_ver=$version"      >> "$GITHUB_ENV"
          echo "VM_ID=$vmid"      >> "$GITHUB_ENV"
          cat > setup_almalinux.sh <<'EOF'
          sudo sed -i '/^PasswordAuthentication/s/no/yes/' /etc/ssh/sshd_config /etc/ssh/sshd_config.d/*.conf
          echo "PermitRootLogin yes" | sudo tee /etc/ssh/sshd_config.d/01-permitrootlogin.conf
          sudo  systemctl restart sshd

          # sudo  systemctl disable --now firewalld
          sudo  sed -i 's|SELINUX=enforcing|SELINUX=disabled|' /etc/selinux/config

          sudo  sed -e 's|^mirrorlist=|#mirrorlist=|g' \
                -e 's|^#.*baseurl=https://.*.almalinux.org|baseurl=https://mirrors.aliyun.com|g' \
                -i.bak \
                /etc/yum.repos.d/almalinux*.repo

          # https://mirrors.cloud.tencent.com/almalinux/
          # https://mirrors.aliyun.com

          # kvm agent
          sudo yum -y install vim wget telnet qemu-guest-agent socat conntrack ebtables ipset
          # å‡çº§kernel å‚è€ƒå…¶ä»–éƒ¨åˆ†

          # ä¿®æ”¹ è®©æœ¬åœ°hostsç”Ÿæ•ˆ
          sudo sed -i '/update_etc_hosts/s/^#*/#/' /etc/cloud/cloud.cfg 

          # å¼€å¯sshdçš„å¯†ç éªŒè¯
          # sudo sed -i '/ssh_pwauth/s/false/true/' /etc/cloud/cloud.cfg
          sudo sed -i '/^disable_root/s/true/false/' /etc/cloud/cloud.cfg

          sudo yum update -y
          sudo yum clean all
          history -c
          sudo init 0
          EOF

          # cat setup_almalinux.sh

      - name: Setup AlmaLinux ${{ github.event.inputs.OS }} Template
        if: contains(github.event.inputs.OS, 'almalinux')
        # if: contains(github.event.inputs.OS, 'almalinux9')
        run: |
          echo setup ${{ github.event.inputs.OS }} Template  ...
          # VM_ID=2009
          cat > setup_almalinux_tpl.sh <<EOF
          # wget -c https://repo.almalinux.org/almalinux/9/cloud/x86_64/images/AlmaLinux-9-GenericCloud-latest.x86_64.qcow2
          wget -c https://repo.almalinux.org/almalinux/${almalinux_ver}/cloud/x86_64/images/AlmaLinux-${almalinux_ver}-GenericCloud-latest.x86_64.qcow2
          # wget -c https://mirrors.aliyun.com/almalinux/${almalinux_ver}/cloud/x86_64/images/AlmaLinux-${almalinux_ver}-GenericCloud-latest.x86_64.qcow2
          # wget -c https://mirrors.cloud.tencent.com/almalinux/9/cloud/x86_64/images/AlmaLinux-9-GenericCloud-latest.x86_64.qcow2
          # wget -c https://mirrors.cloud.tencent.com/almalinux/${almalinux_ver}/cloud/x86_64/images/AlmaLinux-${almalinux_ver}-GenericCloud-latest.x86_64.qcow2
          

          VM_ID=$VM_ID
          qm shutdown ${VM_ID} --forceStop
          sleep 2
          qm destroy ${VM_ID} --purge

          qm create $VM_ID --core 2 --memory 4096 --name almalinux${almalinux_ver}tpl --net0 virtio,bridge=vmbr1
          qm importdisk $VM_ID AlmaLinux-${almalinux_ver}-GenericCloud-latest.x86_64.qcow2 ${STORAGE}
          # å°†æ–°å¯¼å…¥çš„ç£ç›˜ä»¥ scsi é©±åŠ¨å™¨çš„æ–¹å¼è£…è½½åˆ°æ–°å»ºçš„è™šæ‹Ÿæœºçš„ scsi æ§åˆ¶å™¨
          # é€‚ç”¨äºlocal-lvm ${STORAGE}:vm-${VM_ID}-disk-0
          qm set $VM_ID --scsihw virtio-scsi-pci --scsi0 ${STORAGE}:vm-${VM_ID}-disk-0
          # é€‚ç”¨äºlocal ${STORAGE}:${VM_ID}/vm-${VM_ID}-disk-0.raw
          # qm set $VM_ID --scsihw virtio-scsi-pci --scsi0 ${STORAGE}:${VM_ID}/vm-${VM_ID}-disk-0.raw

          qm set $VM_ID --ide2 ${STORAGE}:cloudinit
          qm set $VM_ID --boot cdn --bootdisk scsi0
          qm set $VM_ID --serial0 socket --vga serial0
          qm set $VM_ID --tags "template;${{ github.event.inputs.OS }}"
          # è®¾ç½®ç£ç›˜
          qm disk resize $VM_ID scsi0 20G # è®¾ç½®ç¡¬ç›˜å¤§å°

          # el9éœ€è¦è®¾ç½®CPUä¸ºhost
          [ "${almalinux_ver}" -ge "9" ] && qm set $VM_ID --cpu cputype=host

          # å¯¼å…¥sshå…¬é’¥åˆ°è™šæ‹Ÿç³»ç»Ÿ
          qm set $VM_ID --sshkey ~/.ssh/id_rsa.pub
          qm set $VM_ID --ipconfig0 ip=${CIDR}.250/24,gw=${CIDR}.1  # è®¾ç½®ip
          qm set $VM_ID --cipassword vagrant --ciuser vagrant --ciupgrade 0  # è®¾ç½®ç”¨æˆ·å’Œå¯†ç ã€‚æ³¨æ„å¯†ç åœ¨è®¾ç½®ä¹‹åï¼Œä¼šè‡ªåŠ¨éšè—ã€‚
          # qm set $VM_ID --ssh-pwauth 1
          qm set $VM_ID --searchdomain example.com --nameserver ${DNS}
          qm set $VM_ID --agent 1 # éœ€è¦é…åˆ qemu-guest-agent
          qm start $VM_ID
          sleep 30

          # è®¿é—®
          ssh-keygen -f "/root/.ssh/known_hosts" -R "${CIDR}.250"
          # å°†è„šæœ¬å†…å®¹ä½œä¸ºå‘½ä»¤æ‰§è¡Œ
          # qm guest exec $VM_ID -- bash -c "\$(cat setup_almalinux.sh)"
          # alias ssh='ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null'
          # cat setup_almalinux.sh | ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null vagrant@${CIDR}.250 'bash -s'
          rsync -e  'ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null' \
              -avz --partial --progress --inplace setup_almalinux.sh vagrant@${CIDR}.250:/home/vagrant/
          ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null vagrant@${CIDR}.250 'bash setup_almalinux.sh'          
          EOF

          cat setup_almalinux_tpl.sh

          # copy scripts to PVE
          for pkg in setup_almalinux*.sh
          do
            rsync -e  'ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null' \
              -avz --partial --progress --inplace $pkg root@${{ env.TAILSCALE_HOST }}.${{ env.TAILSCALE_NET }}:/root/
          done

          # exec scripts on PVE
          ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
          root@${{ env.TAILSCALE_HOST }}.${{ env.TAILSCALE_NET }} "bash setup_almalinux_tpl.sh; sleep 5; qm stop $VM_ID; sleep 5;qm set $VM_ID --ciupgrade 1; qm template $VM_ID"

      